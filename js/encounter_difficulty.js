function formatDanger(t){var a=t.val();"0.125"==a||"0,125"==a||"1.8"==a||"1,8"==a||"1-8"==a?a="1/8":"0.25"==a||"0,25"==a||"1.4"==a||"1,4"==a||"1-4"==a?a="1/4":"0.5"!=a&&"0,5"!=a&&"1.2"!=a&&"1,2"!=a&&"1-2"!=a||(a="1/2"),t.val(a)}function setValueCustom(t){$("#master_character_danger").val(t.attr("danger"))}function clearAll(){$("#pc,#mc,#advisable").html(""),$('.part input[type="text"]').val(""),countSteps(),countDifficulty(),showFactors(),highlightStep()}function addRow(t){"player"==t?addPlayer():addMaster(),countSteps(),countDifficulty(),showFactors(),highlightStep(),findAdvisable()}function removeRow(t){t.remove(),countSteps(),countDifficulty(),showFactors(),highlightStep(),findAdvisable()}function addPlayer(){if($(".player").each(function(){""==$(this).val()||$(this).val()<1||$(this).val()>20?$(this).addClass("input_error"):$(this).removeClass("input_error")}),$(".player.input_error").length<1){var t=$("#player_character_count").val(),a=$("#player_character_level").val(),r='<li count="'+t+'" level="'+a+'"><strong>'+t+"</strong> "+getNumEnding(t,["персонаж","персонажа","персонажей"])+" <strong>"+a+'-го</strong> уровня<span title="Удалить" onclick="removeRow($(this).parent());">×</span></li>';$("#pc").append(r)}}function addMaster(){if($(".master").each(function(){""==$(this).val()?$(this).addClass("input_error"):"master_character_danger"!=$(this).attr("id")||$(this).val()in danger?"master_character_count"==$(this).attr("id")&&($(this).val()<1||$(this).val()>20)?$(this).addClass("input_error"):$(this).removeClass("input_error"):$(this).addClass("input_error")}),$(".master.input_error").length<1){var t=$("#master_character_count").val(),a=$("#master_character_danger").val(),r='<li count="'+t+'" danger="'+a+'"><strong>'+t+"</strong> «"+$("#master_character").val()+"» с ПО <strong>"+a+'</strong><span title="Удалить" onclick="removeRow($(this).parent());">×</span></li>';$("#mc").append(r)}}function countSteps(){playerTotal=0,steps=[0,0,0,0],$("#pc li").each(function(){for(var t=parseInt($(this).attr("count")),a=parseInt($(this).attr("level")),r=0;r<4;r++)steps[r]+=t*stepsArr[a][r];playerTotal+=t}),steps.forEach(function(t,a){$("#steps div:eq("+a+") span").text(t)})}function countDifficulty(){difficulty=0,masterTotal=0,totalExp=0,$("#mc li").each(function(){var t=$(this).attr("danger");masterTotal+=parseInt($(this).attr("count")),totalExp+=parseInt(danger[t])*parseInt($(this).attr("count"))}),factorId=1,factorId=masterTotal<2?1:2==masterTotal?2:masterTotal>2&&masterTotal<7?3:masterTotal>6&&masterTotal<11?4:masterTotal>10&&masterTotal<15?5:6,playerTotal>0&&playerTotal<3?factorId++:playerTotal>5&&factorId--}function showFactors(){var t="";0==playerTotal?t+="":playerTotal>0&&playerTotal<3?t+=multiplier[0]:playerTotal>2&&playerTotal<6?t+=multiplier[1]:playerTotal>5&&(t+=multiplier[2]),""!=t&&(t+="<br>"),t+=0==masterTotal?"":1==masterTotal?"Один противник. Нет фактора количества противников.":2==masterTotal?"Несколько противников. Множитель сложности <strong>×1.5</strong>":masterTotal>2&&masterTotal<7?"Несколько противников. Множитель сложности <strong>×2</strong>":masterTotal>6&&masterTotal<11?"Много противников. Множитель сложности <strong>×2.5</strong>":masterTotal>10&&masterTotal<15?"Много противников. Множитель сложности <strong>×3</strong>":"Очень много противников. Множитель сложности <strong>×4</strong>",0!=masterTotal&&(t+="<br>"),""!=t&&(t+="Итоговый множитель сложности: <strong>×"+factor[factorId]+"</strong><br>"),masterTotal>0&&(t+="Итоговая сложность боевой сцены: <strong>"+totalExp*factor[factorId]+"</strong><br>"),masterTotal>0&&playerTotal>1&&(t+="Каждый персонаж получит по <strong>"+Math.round(totalExp*factor[factorId]/playerTotal)+"</strong> опыта"),""!=t?$("#factor").html(t):$("#factor").html("Добавьте персонажей мастера.")}function highlightStep(){$("#steps>div").removeClass("active");var t=totalExp*factor[factorId],a=0;t>0&&playerTotal>0&&(t<steps[1]?a=0:t>=steps[1]&&t<steps[2]?a=1:t>=steps[2]&&t<steps[3]?a=2:t>=steps[3]&&(a=3),$("#steps>div:eq("+a+")").addClass("active"))}function findAdvisable(){0!=steps[1]&&0!=steps[2]&&(min=Math.round(.8*steps[1]),max=Math.round(1.2*steps[2]),$.ajax({url:"/encounter_difficulty/advisable/",type:"post",dataType:"html",data:{min:min,max:max,players:playerTotal},success:function(t){$("#advisable").html(t)}}))}$(window).load(function(){});var stepsArr={1:[25,50,75,100],2:[50,100,150,200],3:[75,150,225,400],4:[125,250,375,500],5:[250,500,750,1100],6:[300,600,900,1400],7:[350,750,1100,1700],8:[450,900,1400,2100],9:[550,1100,1600,2400],10:[600,1200,1900,2800],11:[800,1600,2400,3600],12:[1e3,2e3,3e3,4500],13:[1100,2200,3400,5100],14:[1250,2500,3800,5700],15:[1400,2800,4300,6400],16:[1600,3200,4800,7200],17:[2e3,3900,5900,8800],18:[2100,4200,6300,9500],19:[2400,4900,7300,10900],20:[2800,5700,8500,12700]},multiplier=["Маленький отряд. Битвы усложняются.","Стандартный отряд. Нет факторов отряда","Большой отряд. Битвы упрощаются."],factor=[.5,1,1.5,2,2.5,3,4,5],steps=[0,0,0,0],playerTotal=0,difficulty,masterTotal=0,factorId,totalExp;